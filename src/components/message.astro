---
import "../../public/style/message.css";

const lang = Astro.url.pathname.startsWith("/fr") ? "fr" : "en";

const t = {
  fr: {
    tagline: "SEATRUST GROUP | Int√©grateur Logistique",
    welcome:
      "Bonjour üëã Bienvenue chez <strong>SEATRUST GROUP</strong>.<br><br>Je peux vous aider √† demander un devis, suivre une op√©ration ou contacter notre √©quipe d‚Äôexperts.<br><br>Que souhaitez-vous faire ?",
    btn_quote: "üö¢ Demander un devis",
    btn_track: "üì¶ Suivi / Assistance",
    btn_transit: "üßæ Transit & D√©douanement",
    btn_faq: "‚ùì Questions (FAQ)",
    btn_expert: "‚òéÔ∏è Parler √† un expert",
    placeholder: "√âcrivez ici...",
  },
  en: {
    tagline: "SEATRUST GROUP | Logistics Integrator",
    welcome:
      "Hello üëã Welcome to <strong>SEATRUST GROUP</strong>.<br><br>I can help you request a quote, track an operation, or contact our team of experts.<br><br>What would you like to do?",
    btn_quote: "üö¢ Request a quote",
    btn_track: "üì¶ Tracking / Assistance",
    btn_transit: "üßæ Transit & Customs",
    btn_faq: "‚ùì Quick Questions (FAQ)",
    btn_expert: "‚òéÔ∏è Talk to an expert",
    placeholder: "Write here...",
  },
}[lang];
---

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
></script>

<div class="chat-container hidden" id="chatContainer">
  <!-- HEADER -->
  <div class="chat-header">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div class="online-status-dot"></div>
      <div style="text-align: left;">
        <strong style="display: block; font-size: 14px;"
          >SEATRUST Connect</strong
        >
        <small style="font-size: 9px; opacity: 0.8;">{t.tagline}</small>
      </div>
    </div>
    <button class="close-btn" id="closeChatBtn"><i class="bi bi-x"></i></button>
  </div>

  <!-- CORPS DU CHAT (Contenu Initial) -->
  <div class="chat-body" id="chatBody">
    <div class="message-row receiver">
      <div class="message-bubble" set:html={t.welcome} />
    </div>

    <div class="quick-replies" id="initialActions">
      <div class="quick-reply" onclick="window.startFlow('QUOTE')">
        {t.btn_quote}
      </div>
      <div class="quick-reply" onclick="window.startFlow('TRACK')">
        {t.btn_track}
      </div>
      <div class="quick-reply" onclick="window.startFlow('TRANSIT')">
        {t.btn_transit}
      </div>
      <div class="quick-reply" onclick="window.startFlow('FAQ')">
        {t.btn_faq}
      </div>
      <div class="quick-reply" onclick="window.startFlow('EXPERT')">
        {t.btn_expert}
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="user-input hidden" id="chatFooter">
    <div class="input-wrapper">
      <input
        type="text"
        id="chatMessageInput"
        placeholder={t.placeholder}
        autocomplete="off"
      />
      <button class="send" id="sendMsgBtn"
        ><i class="bi bi-send-fill"></i></button
      >
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- 1. D√âTECTION DE LA LANGUE ET DICTIONNAIRE ---
    const lang = window.location.pathname.startsWith("/fr") ? "fr" : "en";

    const t = {
      fr: {
        track_welcome:
          "üëã D‚Äôaccord ! Pour suivre une op√©ration ou demander une assistance, veuillez entrer votre <strong>num√©ro de BL / Booking</strong>.",
        track_form_title: "üîç D√©tails de l'assistance",
        track_type: "Type : Suivi ou Assistance",
        btn_quote: "üö¢ Demander un devis",
        btn_track: "üì¶ Suivi / Assistance",
        btn_transit: "üßæ Transit & D√©douanement",
        btn_faq: "‚ùì Questions rapides (FAQ)",
        btn_expert: "‚òéÔ∏è Parler √† un expert",
        step1_title:
          "<strong>STEP 1 ‚Äî Qualification</strong><br>Quel est votre axe d'√©change principal ?",
        step_scope: "Quel p√©rim√®tre de service souhaitez-vous ?",
        step_equip: "S√©lectionnez le mode de transport / √©quipement :",
        step_add: "Avez-vous besoin de services additionnels ?",
        step2_title:
          "<strong>üü¢ STEP 2 ‚Äî Key Questions</strong><br>Quel est le type d'op√©ration ?",
        step_origin: "Quelle est l'origine de l'exp√©dition ?",
        step_dest: "Quelle est la destination ? (Pays / Ville)",
        step_cargo: "Quel type de marchandise exp√©diez-vous ?",
        step_temp: "Veuillez indiquer la temp√©rature requise :",
        step_vol: "Pr√©cisez le volume de l'exp√©dition :",
        step_freq: "√Ä quelle fr√©quence exp√©diez-vous ?",
        step_date_title: "üìÖ Date de d√©part souhait√©e",
        step_contact_title: "üë§ Vos Coordonn√©es",
        faq_title: "<strong>Choisissez une cat√©gorie :</strong>",
        faq_write:
          "<strong>√âcrivez votre question :</strong><br><small>(ex: Quels documents pour l‚Äôimport ?)</small>",
        summary_title: "üìå R√©capitulatif de votre demande",
        confirm_send: "‚úÖ Oui, confirmer",
        modify: "‚ùå Modifier",
        final_msg: "‚úÖ Votre demande a √©t√© transmise √† l'√©quipe",
        pref_contact: "Comment pr√©f√©rez-vous √™tre contact√© ?",
        signature: "SEATRUST GROUP | Multimodal Logistics Integrator",
        error_req: "Veuillez remplir les champs obligatoires",
        placeholder_text: "√âcrivez ici...",
      },
      en: {
        track_welcome:
          "üëã Sure! To track an operation or request assistance, please enter your <strong>BL / Booking number</strong>.",
        track_form_title: "üîç Assistance Details",
        track_type: "Type: Tracking or Assistance",
        btn_quote: "üö¢ Request a Quote",
        btn_track: "üì¶ Tracking / Assistance",
        btn_transit: "üßæ Transit & Customs",
        btn_faq: "‚ùì Quick Questions (FAQ)",
        btn_expert: "‚òéÔ∏è Talk to an Expert",
        step1_title:
          "<strong>STEP 1 ‚Äî Qualification</strong><br>What is your main trade lane?",
        step_scope: "What service scope do you require?",
        step_equip: "Select transport mode / equipment:",
        step_add: "Do you require additional services?",
        step2_title:
          "<strong>üü¢ STEP 2 ‚Äî Key Questions</strong><br>What type of operation is this?",
        step_origin: "What is the origin of the shipment?",
        step_dest: "What is the destination? (Country / City)",
        step_cargo: "What type of cargo are you shipping?",
        step_temp: "Please indicate the required temperature:",
        step_vol: "Specify the shipment volume:",
        step_freq: "How frequent are your shipments?",
        step_date_title: "üìÖ Desired departure date",
        step_contact_title: "üë§ Contact Details",
        faq_title: "<strong>Choose a category:</strong>",
        faq_write:
          "<strong>Write your question:</strong><br><small>(ex: Which documents for import?)</small>",
        summary_title: "üìå Request Summary",
        confirm_send: "‚úÖ Yes, confirm",
        modify: "‚ùå Edit",
        final_msg: "‚úÖ Your request has been sent to the team",
        pref_contact: "How should an expert contact you?",
        signature: "SEATRUST GROUP | Multimodal Logistics Integrator",
        error_req: "Please fill in required fields",
        placeholder_text: "Write here...",
      },
    }[lang];

    // --- 2. OBJET DE DONN√âES GLOBAL ---
    window.leadData = {
      flow: "",
      tradeLane: "",
      scope: "",
      equipment: "",
      addServices: "",
      opType: "",
      origin: "",
      destination: "",
      commodity: "",
      reefer: "Non",
      temperature: "",
      volume: "",
      frequency: "",
      departureDate: "",
      blNumber: "",
      trackType: "",
      faqCategory: "",
      faqQuestion: "",
      name: "",
      company: "",
      email: "",
      phone: "",
      holding: "",
      expertLabel: "",
    };

    // --- 3. UI HELPERS ---
    window.addBotMsg = function (html) {
      const chatBody = document.getElementById("chatBody");
      const row = document.createElement("div");
      row.className = "message-row receiver";
      row.innerHTML = `<div class="message-bubble">${html}</div>`;
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    };

    window.addUserMsg = function (text) {
      const chatBody = document.getElementById("chatBody");
      const row = document.createElement("div");
      row.className = "message-row sender";
      row.innerHTML = `<div class="message-bubble">${text}</div>`;
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    };

    window.renderButtons = function (labels, callback) {
      const chatBody = document.getElementById("chatBody");
      const container = document.createElement("div");
      container.className = "quick-replies";
      labels.forEach((l) => {
        const btn = document.createElement("div");
        btn.className = "quick-reply";
        btn.textContent = l;
        btn.onclick = () => {
          container.remove();
          window.addUserMsg(l);
          callback(l);
        };
        container.appendChild(btn);
      });
      chatBody.appendChild(container);
      chatBody.scrollTop = chatBody.scrollHeight;
    };

    // --- 4. GESTION DES FLUX ---
    window.startFlow = function (flow) {
      document.getElementById("initialActions")?.remove();
      window.leadData.flow = flow;

      if (flow === "QUOTE" || flow === "TRANSIT") {
        window.addUserMsg(flow === "QUOTE" ? t.btn_quote : t.btn_transit);
        window.renderQuoteStep1();
      } else if (flow === "TRACK") {
        window.addUserMsg(t.btn_track);
        window.addBotMsg(t.track_welcome);
        window.renderTextStep((val) => {
          window.leadData.blNumber = val;
          window.renderTrackingForm();
        });
      } else if (flow === "FAQ") {
        window.addUserMsg(t.btn_faq);
        window.renderFAQFlow();
      } else if (flow === "EXPERT") {
        window.addUserMsg(t.btn_expert);
        window.renderContactForm();
      }
    };

    // --- FLOW: DEVIS (STEP 1 & 2) ---
    window.renderQuoteStep1 = function () {
      window.addBotMsg(t.step1_title);
      const lanes =
        lang === "fr"
          ? [
              "Export Maroc ‚Üí USA",
              "Export Maroc ‚Üí Canada",
              "Export Maroc ‚Üí Europe",
              "Export Maroc ‚Üí autre",
              "Import vers Maroc",
            ]
          : [
              "Export Morocco ‚Üí USA",
              "Export Morocco ‚Üí Canada",
              "Export Morocco ‚Üí Europe",
              "Export Morocco ‚Üí Other",
              "Import to Morocco",
            ];
      window.renderButtons(lanes, (val) => {
        window.leadData.tradeLane = val;
        window.addBotMsg(t.step_scope);
        window.renderButtons(
          ["Door-to-door", "Conventionnelle", "Quai √† Quai"],
          (scope) => {
            window.leadData.scope = scope;
            window.addBotMsg(t.step_equip);
            window.renderButtons(
              [
                "LCL",
                "FCL",
                "Frigorifique",
                "DRY Standard",
                "CA Atmosph√®re Control",
              ],
              (eq) => {
                window.leadData.equipment = eq;
                if (eq.includes("Frigorifique") || eq.includes("CA"))
                  window.leadData.reefer = "Oui";
                window.addBotMsg(t.step_add);
                const services =
                  lang === "fr"
                    ? [
                        "D√©douanement",
                        "Escale",
                        "Manutention",
                        "Contr√¥les",
                        "Equipage",
                        "Aucun",
                      ]
                    : [
                        "Customs",
                        "Agency",
                        "Handling",
                        "Inspections",
                        "Crew",
                        "None",
                      ];
                window.renderButtons(services, (s) => {
                  window.leadData.addServices = s;
                  window.addBotMsg("Thank you. Let‚Äôs move on to the details.");
                  setTimeout(window.renderQuoteStep2, 800);
                });
              },
            );
          },
        );
      });
    };

    window.renderQuoteStep2 = function () {
      window.addBotMsg(t.step2_title);
      window.renderButtons(
        ["Export", "Import", "Transit uniquement", "Transport"],
        (op) => {
          window.leadData.opType = op;
          window.addBotMsg(t.step_origin);
          window.renderButtons(
            ["Tanger Med", "Casablanca", "Agadir", "Nador", "Other"],
            (o) => {
              window.leadData.origin = o;
              window.addBotMsg(t.step_dest);
              window.renderTextStep((d) => {
                window.leadData.destination = d;
                window.addBotMsg(t.step_cargo);
                const cargo =
                  lang === "fr"
                    ? [
                        "Agricole",
                        "Agroalimentaire",
                        "Packaging",
                        "Machines",
                        "Autre",
                      ]
                    : ["Agriculture", "Food", "Packaging", "Machines", "Other"];
                window.renderButtons(cargo, (c) => {
                  window.leadData.commodity = c;
                  if (window.leadData.reefer === "Oui") {
                    window.addBotMsg(t.step_temp);
                    window.renderButtons(
                      ["Ambiant", "Reefer (Indiquez ¬∞C)", "Unknown"],
                      (temp) => {
                        window.leadData.temperature = temp;
                        window.renderVolumeStep();
                      },
                    );
                  } else {
                    window.renderVolumeStep();
                  }
                });
              });
            },
          );
        },
      );
    };

    window.renderVolumeStep = function () {
      window.addBotMsg(t.step_vol);
      window.renderButtons(
        ["20‚Äô container", "40‚Äô container", "45‚Äô container", "Tonnage"],
        (v) => {
          window.leadData.volume = v;
          window.addBotMsg(t.step_freq);
          window.renderButtons(
            ["Ponctuel", "Hebdo", "Mensuel", "Campagne"],
            (f) => {
              window.leadData.frequency = f;
              window.renderDateForm();
            },
          );
        },
      );
    };

    // --- FLOW: SUIVI (TRACKING) ---
    window.renderTrackingForm = function () {
      const html = `
    <div class="contact-form">
      <h3>${t.track_form_title}</h3>
      <div class="form-group"><label>Nom + Soci√©t√©</label><input type="text" id="t_name" placeholder="Ahmed / SEATRUST"></div>
      <div class="form-group"><label>Email / T√©l√©phone</label><input type="text" id="t_contact" placeholder="contact@mail.com"></div>
      <div class="form-group"><label>Origine / Destination (Optionnel)</label><input type="text" id="t_route"></div>
      <div class="form-group"><label>${t.track_type}</label><select id="t_kind"><option value="Suivi">‚úÖ Suivi</option><option value="Assistance">üß∞ Assistance</option></select></div>
      <button class="submit-btn" onclick="window.submitTrackForm()" style="width:100%; margin-top:10px;">Suivant</button>
    </div>`;
      window.addBotMsg(html);
    };

    window.submitTrackForm = function () {
      window.leadData.name = document.getElementById("t_name").value;
      window.leadData.email = document.getElementById("t_contact").value;
      window.leadData.origin = document.getElementById("t_route").value;
      window.leadData.trackType = document.getElementById("t_kind").value;
      if (!window.leadData.name || !window.leadData.email)
        return alert(t.error_req);
      window.renderFinalSummary();
    };

    // --- FLOW: FAQ ---
    window.renderFAQFlow = function () {
      window.addBotMsg(t.faq_title);
      const cats = [
        "üö¢ Maritime",
        "üßæ Transit",
        "‚öì Port",
        "üì¶ Affr√®tement",
        "üßØ Inspections",
        "üóÇÔ∏è Autres",
        "‚òéÔ∏è Expert",
      ];
      window.renderButtons(cats, (cat) => {
        if (cat.includes("Expert")) return window.renderContactForm();
        window.leadData.faqCategory = cat;
        window.addBotMsg(t.faq_write);
        window.renderTextStep((q) => {
          window.leadData.faqQuestion = q;
          window.renderContactForm();
        });
      });
    };

    // --- FORMULAIRES COMMUNS ---
    window.renderDateForm = function () {
      const html = `
    <div class="contact-form">
      <h3>${t.step_date_title}</h3>
      <input type="date" id="q_date" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
      <button class="submit-btn" onclick="window.submitDate()" style="width:100%; margin-top:10px;">Suivant</button>
    </div>`;
      window.addBotMsg(html);
    };

    window.submitDate = function () {
      const d = document.getElementById("q_date").value;
      if (!d) return alert(t.error_req);
      window.leadData.departureDate = d;
      window.renderContactForm();
    };

    window.renderContactForm = function () {
      const html = `
    <div class="contact-form">
      <h3>${t.step_contact_title}</h3>
      <div class="form-group"><label>Nom</label><input type="text" id="c_name"></div>
      <div class="form-group"><label>Soci√©t√©</label><input type="text" id="c_comp"></div>
      <div class="form-group"><label>Email</label><input type="email" id="c_mail"></div>
      <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="c_tel"></div>
      <button class="submit-btn" onclick="window.submitFinalLead()" style="width:100%; margin-top:10px;">Valider</button>
    </div>`;
      window.addBotMsg(html);
    };

    window.submitFinalLead = function () {
      window.leadData.name = document.getElementById("c_name").value;
      window.leadData.company = document.getElementById("c_comp").value;
      window.leadData.email = document.getElementById("c_mail").value;
      window.leadData.phone = document.getElementById("c_tel").value;
      if (!window.leadData.name || !window.leadData.email)
        return alert(t.error_req);
      window.renderFinalSummary();
    };

    // --- FINAL: R√âCAPITULATIF & ROUTAGE ---
    window.renderFinalSummary = function () {
      // LOGIQUE DE ROUTAGE (Holding Calculation)
      const cargo = (window.leadData.commodity || "").toLowerCase();
      const equipment = (window.leadData.equipment || "").toLowerCase();
      const services = (window.leadData.addServices || "").toLowerCase();
      const faq = (window.leadData.faqCategory || "").toLowerCase();
      const scope = (window.leadData.scope || "").toLowerCase();

      // On regroupe tout le contexte pour une recherche plus pr√©cise
      const context = cargo + equipment + services + faq + scope;

      if (
        window.leadData.reefer === "Oui" ||
        /agri|froid|reefer/i.test(context)
      ) {
        window.leadData.holding = "UNIREEF";
        window.leadData.expertLabel =
          lang === "fr"
            ? "expert cha√Æne du froid / Reefer"
            : "cold chain / Reefer expert";
      } else if (
        /transit|douane/i.test(context) ||
        window.leadData.opType === "Transit"
      ) {
        window.leadData.holding = "OWN";
        window.leadData.expertLabel =
          lang === "fr"
            ? "expert transit & douane"
            : "transit & customs expert";
      } else if (/port|escale|manutention|agency/i.test(context)) {
        window.leadData.holding = "INTERNAVI";
        window.leadData.expertLabel =
          lang === "fr"
            ? "expert port & documentation"
            : "port & documentation expert";
      } else if (/maritime|travers√©e|planning|multimodal/i.test(context)) {
        window.leadData.holding = "MSS";
        window.leadData.expertLabel =
          lang === "fr"
            ? "expert maritime & multimodal"
            : "maritime & multimodal expert";
      } else if (
        /transport domestique|distribution|coordination|compl√©mentaire/i.test(
          context,
        )
      ) {
        window.leadData.holding = "BTS";
        window.leadData.expertLabel =
          lang === "fr"
            ? "√©quipe support & coordination"
            : "support & coordination team";
      } else {
        window.leadData.holding = "SEATRUST GROUP";
        window.leadData.expertLabel =
          lang === "fr" ? "expert logistique" : "logistics expert";
      }

      // CONSTRUCTION DU R√âCAPITULATIF (SANS LIGNES VIDES)
      let rows = `<strong>${t.summary_title}</strong><br>`;
      if (window.leadData.blNumber)
        rows += `‚Ä¢ BL / Booking : ${window.leadData.blNumber}<br>`;

      // Type Logic (D2D support)
      let type = window.leadData.opType || window.leadData.trackType;
      if (window.leadData.scope?.includes("door")) type = "D2D";
      if (type) rows += `Type : ${type}<br>`;

      if (window.leadData.origin)
        rows += `Origine : ${window.leadData.origin}<br>`;
      if (window.leadData.destination)
        rows += `Destination : ${window.leadData.destination}<br>`;
      if (window.leadData.commodity)
        rows += `Marchandise : ${window.leadData.commodity}<br>`;

      let reeferVal = window.leadData.reefer;
      if (window.leadData.temperature && reeferVal === "Oui")
        reeferVal += ` (${window.leadData.temperature})`;
      rows += `Reefer : ${reeferVal}<br>`;

      if (window.leadData.volume)
        rows += `Volume : ${window.leadData.volume}<br>`;
      if (window.leadData.departureDate)
        rows += `Date souhait√©e : ${window.leadData.departureDate}<br>`;
      if (window.leadData.faqQuestion)
        rows += `Question : ${window.leadData.faqQuestion}<br>`;

      rows += `Contact : ${window.leadData.name} (${window.leadData.company}) / ${window.leadData.phone || ""} / ${window.leadData.email}`;

      const displayHolding =
        window.leadData.holding === "MSS"
          ? "SEATRUST GROUP"
          : window.leadData.holding;

      const html = `
    <div class="summary-box">${rows}</div>
    ${t.ready_send}<br>
    <div class="quick-replies" style="margin-top:10px">
      <div class="quick-reply" onclick="window.confirmFinal('SEND')">${t.confirm_send}</div>
      <div class="quick-reply" onclick="window.confirmFinal('EDIT')">${t.modify}</div>
    </div>`;
      window.addBotMsg(html);
    };

    window.confirmFinal = function (choice) {
      if (choice === "SEND") {
        const displayHolding =
          window.leadData.holding === "MSS"
            ? "SEATRUST GROUP"
            : window.leadData.holding;
        window.addBotMsg(
          `${t.final_msg} <strong>${displayHolding}</strong>.<br>${t.pref_contact}`,
        );
        const prefs =
          lang === "fr"
            ? ["üìû Appel", "üí¨ WhatsApp", "‚úâÔ∏è Email"]
            : ["üìû Call", "üí¨ WhatsApp", "‚úâÔ∏è Email"];
        window.renderButtons(prefs, (p) => {
          window.addBotMsg(`<em>${t.signature}</em>`);
          console.log("LEAD_FINAL_DATA:", window.leadData);
        });
      } else {
        window.addUserMsg(t.modify);
        window.renderContactForm();
      }
    };

    // --- CORE UTILS ---
    window.renderTextStep = function (callback) {
      const footer = document.getElementById("chatFooter");
      const input = document.getElementById("chatMessageInput");
      const btn = document.getElementById("sendMsgBtn");
      footer.classList.remove("hidden");
      input.placeholder = t.placeholder_text;
      input.focus();
      const handler = () => {
        const val = input.value.trim();
        if (val) {
          footer.classList.add("hidden");
          window.addUserMsg(val);
          input.value = "";
          btn.onclick = null;
          callback(val);
        }
      };
      btn.onclick = handler;
      input.onkeypress = (e) => {
        if (e.key === "Enter") handler();
      };
    };

    // TRIGGER EVENTS
   
    let autoCloseTimer = null;
    let hasInteracted = false; // Flag pour savoir si l'utilisateur a utilis√© le bot
    const isMobile = () => window.innerWidth <= 768;

    // --- FONCTION : MARQUER COMME ACTIF (D√©sactive l'auto-fermeture) ---
    function stopAutoClosing() {
      hasInteracted = true;
      if (autoCloseTimer) {
        clearTimeout(autoCloseTimer);
        autoCloseTimer = null;
        console.log("Auto-fermeture d√©sactiv√©e : l'utilisateur est actif.");
      }
    }

    // --- OUVERTURE AUTOMATIQUE (5 secondes) ---
    setTimeout(() => {
      // On n'ouvre que si le chat est encore cach√©
      if (chatContainer.classList.contains("hidden")) {
        chatContainer.classList.remove("hidden");

        // Si on est sur Desktop ET qu'il n'y a pas encore eu d'interaction manuelle
        if (!isMobile() && !hasInteracted) {
          autoCloseTimer = setTimeout(() => {
            if (!hasInteracted && !chatContainer.classList.contains("hidden")) {
              chatContainer.classList.add("hidden");
              console.log("Ferm√© par inactivit√© initiale");
            }
          }, 10000); // 10 secondes d'attente
        }
      }
    }, 5000);

    // --- GESTION DU CLIC SUR L'IC√îNE (MANUEL) ---
    chatTrigger.onclick = () => {
      stopAutoClosing(); // D√©sactive l'auto-fermeture d√®s qu'on touche √† l'ic√¥ne
      chatContainer.classList.toggle("hidden");
    };

    // --- D√âTECTION D'INTERACTION DANS LE CHAT ---
    // N'importe quel clic √† l'int√©rieur (boutons, liens) stoppe le timer d√©finitivement
    chatContainer.addEventListener("click", () => {
      stopAutoClosing();
    });

    
    document.getElementById("closeChatBtn").onclick = () =>
      document.getElementById("chatContainer").classList.add("hidden");
  });
</script>
