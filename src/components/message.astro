---
import "../../public/style/message.css";
---

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<!-- Ic√¥ne Flottante (Trigger) -->
<!-- <div class="chat-icon" id="chatTrigger">
  <i class="bi bi-chat-dots-fill"></i>
</div> -->

<!-- Conteneur Principal du Chat -->
<div class="chat-container hidden" id="chatContainer">
  <!-- HEADER -->
  <div class="chat-header">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div class="online-status-dot"></div>
        <div style="text-align: left;">
            <strong style="display: block; font-size: 14px;">SEATRUST Connect</strong>
            <small style="font-size: 9px; opacity: 0.8;">SEATRUST GROUP | Multimodal Logistics Integrator</small>
        </div>
    </div>
    <button class="close-btn" id="closeChatBtn">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <!-- ZONE DE MESSAGES -->
  <div class="chat-body" id="chatBody">
    <div class="message-row receiver">
      <div class="message-bubble">
        Bonjour üëã Bienvenue chez <strong>SEATRUST GROUP</strong>.<br><br>
        Je peux vous aider √† demander un devis, suivre une op√©ration ou contacter notre √©quipe d‚Äôexperts Logistique et/ou Transit & Douane.<br><br>
        Que souhaitez-vous faire ?
      </div>
    </div>

    <!-- BOUTONS D'ACCUEIL -->
    <div class="quick-replies" id="initialActions">
        <div class="quick-reply" onclick="window.startFlow('QUOTE')">üö¢ Demander un devis</div>
        <div class="quick-reply" onclick="window.startFlow('TRACK')">üì¶ Suivre / Assistance</div>
        <div class="quick-reply" onclick="window.startFlow('TRANSIT')">üßæ Transit & D√©douanement</div>
        <div class="quick-reply" onclick="window.startFlow('FAQ')">‚ùì Questions (FAQ)</div>
        <div class="quick-reply" onclick="window.startFlow('EXPERT')">‚òéÔ∏è Parler √† un expert</div>
    </div>
  </div>

  <!-- FOOTER (Masqu√© par d√©faut car on utilise des formulaires) -->
  <div class="user-input hidden" id="chatFooter">
      <div class="input-wrapper">
        <input type="text" id="chatMessageInput" placeholder="√âcrivez ici..." autocomplete="off" />
        <button class="send" id="sendMsgBtn"><i class="bi bi-send-fill"></i></button>
      </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

  // Initialisation des donn√©es globales
  window.leadData = {
    type: "", origin: "", destination: "", commodity: "", 
    reefer: "Non", temp: "", volume: "", frequency: "", 
    urgency: "", name: "", company: "", email: "", phone: "",
    holding: "", expertLabel: "", contactPref: "", slot: ""
  };

  // --- LOGIQUE DE ROUTAGE VERS FILIALES ---
  window.calculateRouting = function() {
    const cargo = window.leadData.commodity.toLowerCase();
    const isReefer = window.leadData.reefer === "Oui";
    
    if (isReefer || ["agricole", "agroalimentaire", "froid", "p√©rissable", "fruits", "l√©gumes"].some(w => cargo.includes(w))) {
        window.leadData.holding = "UNIREEF";
        window.leadData.expertLabel = "expert cha√Æne du froid / Reefer";
    } else if (window.leadData.type === "Transit" || ["transit", "d√©douanement", "douane", "hs code"].some(w => cargo.includes(w))) {
        window.leadData.holding = "OWN";
        window.leadData.expertLabel = "expert transit & douane";
    } else if (["formalit√©s", "port", "bl", "hipping agency", "escale"].some(w => cargo.includes(w))) {
        window.leadData.holding = "INTERNAVI";
        window.leadData.expertLabel = "expert port & documentation";
    } else if (["transport", "routier", "camion", "domestique", "distribution"].some(w => cargo.includes(w))) {
        window.leadData.holding = "BTS";
        window.leadData.expertLabel = "√©quipe support surveillance & contr√¥le";
    } else {
        window.leadData.holding = "MSS";
        window.leadData.expertLabel = "expert maritime & multimodal";
    }
  };

  // --- FONCTIONS D'INTERFACE ---
  window.addBotMsg = function(html) {
    const chatBody = document.getElementById("chatBody");
    const row = document.createElement("div");
    row.className = "message-row receiver";
    row.innerHTML = `<div class="message-bubble">${html}</div>`;
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  };

  window.addUserMsg = function(text) {
    const chatBody = document.getElementById("chatBody");
    const row = document.createElement("div");
    row.className = "message-row sender";
    row.innerHTML = `<div class="message-bubble">${text}</div>`;
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  };

  // --- GESTION DES FLUX (Flows) ---
  window.startFlow = function(flow) {
    document.getElementById("initialActions")?.remove();
    
    if (flow === 'QUOTE' || flow === 'TRANSIT') {
      window.leadData.type = flow === 'QUOTE' ? "Maritime/Multimodal" : "Transit";
      window.addUserMsg(flow === 'QUOTE' ? "Demander un devis" : "Transit & D√©douanement");
      window.addBotMsg("C'est entendu. Pour vous fournir une cotation pr√©cise, merci de renseigner l'itin√©raire :");
      window.renderStep1Form();
    } else if (flow === 'TRACK') {
        window.addUserMsg("Suivre une op√©ration");
        window.addBotMsg("Veuillez saisir votre num√©ro de dossier ou BL pour obtenir l'assistance op√©rationnelle.");
        document.getElementById("chatFooter").classList.remove("hidden");
    } else if (flow === 'FAQ') {
        window.addBotMsg("<strong>FAQ Rapide :</strong><br>‚Ä¢ Cotation : < 24h<br>‚Ä¢ Couverture : Tous les ports du Maroc<br>‚Ä¢ Transit : OWN est notre bureau sp√©cialis√©.");
    } else {
        window.addUserMsg("Parler √† un expert");
        window.renderContactForm();
    }
  };

  // FORMULAIRE √âTAPE 1 : ITINERAIRE
  window.renderStep1Form = function() {
    const html = `
      <div class="contact-form">
        <h3>üìç Itin√©raire & Type</h3>
        <div class="form-group">
            <label>Type d'op√©ration</label>
            <select id="input_type">
                <option value="Export">Export Maroc</option>
                <option value="Import">Import vers Maroc</option>
                <option value="Transit">Transit uniquement</option>
            </select>
        </div>
        <div class="form-group">
            <label>Origine (Port/Ville)</label>
            <input type="text" id="input_origin" placeholder="Ex: Tanger Med">
        </div>
        <div class="form-group">
            <label>Destination (Pays/Ville)</label>
            <input type="text" id="input_dest" placeholder="Ex: New York, USA">
        </div>
        <button class="submit-btn" onclick="window.submitStep1()">Suivant</button>
      </div>`;
    window.addBotMsg(html);
  };

  window.submitStep1 = function() {
    const type = document.getElementById("input_type").value;
    const origin = document.getElementById("input_origin").value;
    const dest = document.getElementById("input_dest").value;
    if(!origin || !dest) return alert("Veuillez remplir l'origine et la destination.");
    
    window.leadData.type = type;
    window.leadData.origin = origin;
    window.leadData.destination = dest;
    
    window.addUserMsg(`${type} de ${origin} √† ${dest}`);
    window.addBotMsg("Parfait. Maintenant, pr√©cisez la nature de la cargaison :");
    window.renderStep2Form();
  };

  // FORMULAIRE √âTAPE 2 : CARGO & VOLUMES
  window.renderStep2Form = function() {
    const html = `
      <div class="contact-form">
        <h3>üì¶ D√©tails Logistiques</h3>
        <div class="form-group">
            <label>Marchandise</label>
            <select id="input_commodity">
                <option value="Agricole">Agricole / P√©rissable</option>
                <option value="Machines">Machines / √âquipements</option>
                <option value="Packaging">Packaging</option>
                <option value="Autre">Autre</option>
            </select>
        </div>
        <div class="form-group">
            <label>Froid (Reefer) ?</label>
            <select id="input_reefer">
                <option value="Non">Non (Ambiant)</option>
                <option value="Oui">Oui (Contr√¥l√©)</option>
            </select>
        </div>
        <div class="form-group">
            <label>Volume (20'/40'/LCL)</label>
            <input type="text" id="input_volume" placeholder="Ex: 2x 40ft High Cube">
        </div>
        <div class="form-group">
            <label>Urgence (Date d√©part)</label>
            <input type="text" id="input_urgency" placeholder="Ex: Semaine prochaine">
        </div>
        <button class="submit-btn" onclick="window.submitStep2()">Suivant</button>
      </div>`;
    window.addBotMsg(html);
  };

  window.submitStep2 = function() {
    window.leadData.commodity = document.getElementById("input_commodity").value;
    window.leadData.reefer = document.getElementById("input_reefer").value;
    window.leadData.volume = document.getElementById("input_volume").value;
    window.leadData.urgency = document.getElementById("input_urgency").value;
    
    window.addUserMsg(`${window.leadData.commodity} | Volume: ${window.leadData.volume}`);
    window.addBotMsg("Merci. Enfin, merci d'indiquer vos coordonn√©es pour recevoir le devis.");
    window.renderContactForm();
  };

  // FORMULAIRE √âTAPE 3 : COORDONN√âES
  window.renderContactForm = function() {
    const html = `
      <div class="contact-form">
        <h3>üë§ Vos Coordonn√©es</h3>
        <div class="form-group">
            <label>Nom & Pr√©nom</label>
            <input type="text" id="input_name" placeholder="Votre nom">
        </div>
        <div class="form-group">
            <label>Soci√©t√©</label>
            <input type="text" id="input_company" placeholder="Votre entreprise">
        </div>
        <div class="form-group">
            <label>Email Professionnel</label>
            <input type="email" id="input_email" placeholder="email@domaine.com">
        </div>
        <div class="form-group">
            <label>T√©l√©phone / WhatsApp</label>
            <input type="tel" id="input_phone" placeholder="+212 ...">
        </div>
        <button class="submit-btn" onclick="window.submitContact()">Voir le r√©capitulatif</button>
      </div>`;
    window.addBotMsg(html);
  };

  window.submitContact = function() {
    window.leadData.name = document.getElementById("input_name").value;
    window.leadData.company = document.getElementById("input_company").value;
    window.leadData.email = document.getElementById("input_email").value;
    window.leadData.phone = document.getElementById("input_phone").value;

    if(!window.leadData.name || !window.leadData.email) return alert("Nom et Email requis.");
    
    window.addUserMsg(`${window.leadData.name} - ${window.leadData.company}`);
    window.calculateRouting();
    window.renderSummary();
  };

  // R√âCAPITULATIF & CONFIRMATION DE RAPPEL
  window.renderSummary = function() {
    const html = `
      <div class="summary-box">
        <strong>üìå R√©capitulatif de votre demande</strong><br>
        ‚Ä¢ Type : ${window.leadData.type}<br>
        ‚Ä¢ Trajet : ${window.leadData.origin} ‚ûî ${window.leadData.destination}<br>
        ‚Ä¢ Marchandise : ${window.leadData.commodity}<br>
        ‚Ä¢ Reefer : ${window.leadData.reefer}<br>
        ‚Ä¢ Volume : ${window.leadData.volume}<br>
        ‚Ä¢ Soci√©t√© : ${window.leadData.company}<br><br>
        ‚úÖ Demande enregistr√©e sous l'ID: <strong>ST-${Date.now().toString().slice(-6)}</strong>
      </div>
      <br>Souhaitez-vous √™tre rappel√© par un expert <strong>${window.leadData.holding}</strong> ?
      <div class="quick-replies" style="margin-top:10px">
        <div class="quick-reply" onclick="window.confirmCallback('OUI')">‚úÖ Oui</div>
        <div class="quick-reply" onclick="window.confirmCallback('NON')">‚ùå Non</div>
      </div>`;
    window.addBotMsg(html);
  };

  window.confirmCallback = function(choice) {
    if(choice === 'OUI') {
        window.addUserMsg("Oui, je souhaite √™tre rappel√©.");
        window.addBotMsg(`Parfait. Comment l'expert <strong>${window.leadData.holding}</strong> doit-il vous contacter ?`);
        const html = `
            <div class="quick-replies">
                <div class="quick-reply" onclick="window.finalStep('Appel')">üìû Appel t√©l√©phonique</div>
                <div class="quick-reply" onclick="window.finalStep('WhatsApp')">üí¨ WhatsApp</div>
                <div class="quick-reply" onclick="window.finalStep('Email')">‚úâÔ∏è Email</div>
            </div>`;
        window.addBotMsg(html);
    } else {
        window.addUserMsg("Non, merci.");
        window.finalStep('Email uniquement');
    }
  };

  window.finalStep = function(pref) {
    window.leadData.contactPref = pref;
    window.addBotMsg(`Merci ${window.leadData.name}. Un <strong>${window.leadData.expertLabel}</strong> traitera votre demande en priorit√©.`);
    window.addBotMsg("Signature : <em>SEATRUST GROUP | Multimodal Logistics Integrator</em>");
    console.log("SENDING TO CRM/SALES TEAM:", window.leadData);
    // Ici int√©gration EmailJS possible
  };

  // GESTION DES BOUTONS DE TRIGGER
  document.getElementById("chatTrigger").onclick = function() {
    document.getElementById("chatContainer").classList.toggle("hidden");
  };

  document.getElementById("closeChatBtn").onclick = function() {
    document.getElementById("chatContainer").classList.add("hidden");
  };

  // Saisie libre (uniquement pour le tracking)
  document.getElementById("sendMsgBtn").onclick = function() {
    const input = document.getElementById("chatMessageInput");
    if(input.value.trim()) {
        window.addUserMsg(input.value);
        window.addBotMsg("Transmission des informations de suivi √† l'√©quipe op√©rationnelle...");
        input.value = "";
    }
  };
});
</script>

