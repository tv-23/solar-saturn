---
import "../../public/style/message.css";
---

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
></script>

<div class="chat-container hidden" id="chat-box">
  <!-- HEADER DU BOT -->
  <div class="chat-header">
    <div class="header-info">
      <span class="online-dot"></span>
      <div>
        <p class="bot-name">SEATRUST Connect</p>
        <p class="bot-signature">
          SEATRUST GROUP | Multimodal Logistics Integrator
        </p>
      </div>
    </div>
    <button class="close-btn" id="closeChat">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <!-- CORPS DU CHAT -->
  <div class="chat-body" id="chatBody">
    <!-- MESSAGE D'ACCUEIL INITIAL (Hardcoded pour rapidit√©) -->
    <div class="message-row receiver">
      <div class="message-bubble">
        Bonjour üëã Bienvenue chez <strong>SEATRUST GROUP</strong>.<br /><br />
        Je peux vous aider √† demander un devis, suivre une op√©ration ou contacter
        notre √©quipe d‚Äôexperts Logistique et/ou Transit & Douane.<br /><br />
        Que souhaitez-vous faire ?
      </div>
    </div>

    <!-- BOUTONS D'ACCUEIL (√âtape 1) -->
    <div class="quick-replies" id="initial-actions">
      <button class="quick-reply" onclick="handleFlow('QUOTE')"
        >üö¢ Demander un devis</button
      >
      <button class="quick-reply" onclick="handleFlow('TRACK')"
        >üì¶ Suivre / Assistance op√©rationnelle</button
      >
      <button class="quick-reply" onclick="handleFlow('TRANSIT')"
        >üßæ Transit & D√©douanement (partout au Maroc)</button
      >
      <button class="quick-reply" onclick="handleFlow('FAQ')"
        >‚ùì Questions rapides (FAQ)</button
      >
      <button class="quick-reply" onclick="handleFlow('EXPERT')"
        >‚òéÔ∏è Parler √† un expert</button
      >
    </div>
  </div>

  <!-- ZONE DE SAISIE (Masqu√©e par d√©faut, activ√©e pour les questions ouvertes) -->
  <div class="chat-footer hidden" id="chatFooter">
    <input
      type="text"
      id="userInput"
      placeholder="√âcrivez ici..."
      autocomplete="off"
    />
    <button id="sendBtn"><i class="bi bi-send-fill"></i></button>
  </div>
</div>

<!-- D√âCLENCHEUR FLOTTANT -->
<!-- <button id="chat-button" class="chat-trigger">
    <i class="bi bi-chat-dots-fill"></i>
</button> -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- √âTAT GLOBAL DU BOT ---
    let currentState = "START";
    let leadData = {
      type: "",
      origin: "",
      destination: "",
      commodity: "",
      reefer: "Non",
      temp: "",
      volume: "",
      frequency: "",
      urgency: "",
      name: "",
      company: "",
      email: "",
      phone: "",
      holding: "",
      contactPref: "",
      slot: "",
    };

    // --- LOGIQUE DE ROUTAGE VERS FILIALES (Sp√©cifications client) ---
    window.routeToHolding = function () {
      const commodity = leadData.commodity.toLowerCase();
      const isReefer = leadData.reefer === "Oui";

      if (
        isReefer ||
        [
          "agricole",
          "agroalimentaire",
          "froid",
          "p√©rissable",
          "fruits",
          "l√©gumes",
        ].some((w) => commodity.includes(w))
      ) {
        return { name: "UNIREEF", expert: "expert cha√Æne du froid / Reefer" };
      }
      if (
        leadData.type === "Transit" ||
        ["transit", "d√©douanement", "douane", "hs code"].some((w) =>
          commodity.includes(w),
        )
      ) {
        return { name: "OWN", expert: "expert transit & douane" };
      }
      if (
        ["formalit√©s", "port", "bl", "escale", "√©quipage"].some((w) =>
          commodity.includes(w),
        )
      ) {
        return { name: "INTERNAVI", expert: "expert port & documentation" };
      }
      if (
        ["transport", "routier", "domestique", "distribution"].some((w) =>
          commodity.includes(w),
        )
      ) {
        return {
          name: "BTS",
          expert: "√©quipe support surveillance & contr√¥le",
        };
      }
      return { name: "MSS", expert: "expert maritime & multimodal" };
    };

    // --- FONCTIONS INTERFACE ---
    window.addBotMessage = function (text) {
      const chatBody = document.getElementById("chatBody");
      const row = document.createElement("div");
      row.className = "message-row receiver";
      row.innerHTML = `<div class="message-bubble">${text}</div>`;
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    };

    window.addUserMessage = function (text) {
      const chatBody = document.getElementById("chatBody");
      const row = document.createElement("div");
      row.className = "message-row sender";
      row.innerHTML = `<div class="message-bubble">${text}</div>`;
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    };

    window.showChoices = function (options) {
      const chatBody = document.getElementById("chatBody");
      const container = document.createElement("div");
      container.className = "quick-replies dynamic-replies";
      options.forEach((opt) => {
        const btn = document.createElement("button");
        btn.className = "quick-reply";
        btn.textContent = opt.label;
        btn.onclick = () => {
          container.remove();
          handleChoice(opt);
        };
        container.appendChild(btn);
      });
      chatBody.appendChild(container);
      chatBody.scrollTop = chatBody.scrollHeight;
    };

    window.toggleInput = function (show) {
      const footer = document.getElementById("chatFooter");
      footer.classList.toggle("hidden", !show);
      if (show) document.getElementById("userInput").focus();
    };

    // --- GESTION DES FLUX (Flow Plan) ---
    window.handleFlow = function (flow) {
      document.getElementById("initial-actions")?.remove();

      if (flow === "QUOTE" || flow === "TRANSIT") {
        addUserMessage(
          flow === "QUOTE" ? "Demander un devis" : "Transit & D√©douanement",
        );
        currentState = "SELECT_OP_TYPE";
        nextStep();
      } else if (flow === "TRACK") {
        addUserMessage("Suivre une op√©ration");
        addBotMessage(
          "Veuillez saisir votre num√©ro de dossier ou le nom de votre soci√©t√© pour une assistance op√©rationnelle.",
        );
        currentState = "ASK_NAME";
        toggleInput(true);
      } else if (flow === "FAQ") {
        addBotMessage(
          "<strong>FAQ Rapide :</strong><br>‚Ä¢ D√©lais devis : < 24h<br>‚Ä¢ Pr√©sence : Tous les ports du Maroc<br>‚Ä¢ Services : Multimodal, Transit, Agence.",
        );
        addBotMessage("Besoin d'autre chose ?");
      } else if (flow === "EXPERT") {
        currentState = "ASK_NAME";
        nextStep();
      }
    };

    window.handleChoice = function (opt) {
      addUserMessage(opt.label);
      if (opt.field) leadData[opt.field] = opt.value;
      currentState = opt.next;
      nextStep();
    };

    window.nextStep = function () {
      toggleInput(false);

      switch (currentState) {
        case "SELECT_OP_TYPE":
          addBotMessage("√âtape 1 : Quel est le type d'op√©ration ?");
          showChoices([
            {
              label: "Export Maroc ‚ûî USA/Canada",
              value: "Export NA",
              field: "type",
              next: "ASK_ORIGIN",
            },
            {
              label: "Export Maroc ‚ûî Europe",
              value: "Export EU",
              field: "type",
              next: "ASK_ORIGIN",
            },
            {
              label: "Import vers le Maroc",
              value: "Import",
              field: "type",
              next: "ASK_ORIGIN",
            },
            {
              label: "Transit Douane uniquement",
              value: "Transit",
              field: "type",
              next: "ASK_ORIGIN",
            },
          ]);
          break;

        case "ASK_ORIGIN":
          addBotMessage("Origine de la marchandise ? (Port ou Ville)");
          toggleInput(true);
          break;

        case "ASK_DEST":
          addBotMessage("Destination finale ? (Pays / Ville)");
          toggleInput(true);
          break;

        case "ASK_COMMODITY":
          addBotMessage(
            "Nature de la marchandise ? (Agricole, Agro, Machines, Packaging...)",
          );
          toggleInput(true);
          break;

        case "ASK_REEFER":
          addBotMessage("Transport sous temp√©rature contr√¥l√©e (Reefer) ?");
          showChoices([
            {
              label: "‚úÖ Oui",
              value: "Oui",
              field: "reefer",
              next: "ASK_TEMP",
            },
            { label: "‚ùå Non", value: "Non", field: "reefer", next: "ASK_VOL" },
          ]);
          break;

        case "ASK_TEMP":
          addBotMessage("Pr√©cisez la temp√©rature en ¬∞C :");
          toggleInput(true);
          break;

        case "ASK_VOL":
          addBotMessage("Volume de l'envoi ?");
          showChoices([
            {
              label: "FCL 20'",
              value: "20ft",
              field: "volume",
              next: "ASK_FREQ",
            },
            {
              label: "FCL 40'",
              value: "40ft",
              field: "volume",
              next: "ASK_FREQ",
            },
            {
              label: "LCL (Groupage)",
              value: "LCL",
              field: "volume",
              next: "ASK_FREQ",
            },
          ]);
          break;

        case "ASK_FREQ":
          addBotMessage("Fr√©quence d'exp√©dition ?");
          showChoices([
            {
              label: "Ponctuel",
              value: "One-shot",
              field: "frequency",
              next: "ASK_URGENCY",
            },
            {
              label: "R√©gulier (Hebdo/Mensuel)",
              value: "Regular",
              field: "frequency",
              next: "ASK_URGENCY",
            },
          ]);
          break;

        case "ASK_URGENCY":
          addBotMessage("Date de d√©part souhait√©e ? (Mois ou date pr√©cise)");
          toggleInput(true);
          break;

        case "ASK_NAME":
          addBotMessage(
            "Merci. Vos coordonn√©es pour le r√©capitulatif. Votre Nom & Soci√©t√© ?",
          );
          toggleInput(true);
          break;

        case "ASK_CONTACT":
          addBotMessage("Votre Email et T√©l√©phone ?");
          toggleInput(true);
          break;

        case "SUMMARY":
          const routing = routeToHolding();
          leadData.holding = routing.name;
          const summaryHTML = `
                üìå <strong>R√©capitulatif de votre demande</strong><br>
                ‚Ä¢ Type : ${leadData.type}<br>
                ‚Ä¢ Trajet : ${leadData.origin} ‚ûî ${leadData.destination}<br>
                ‚Ä¢ Marchandise : ${leadData.commodity}<br>
                ‚Ä¢ Reefer : ${leadData.reefer} ${leadData.temp ? "(" + leadData.temp + "¬∞C)" : ""}<br>
                ‚Ä¢ Volume : ${leadData.volume}<br>
                ‚Ä¢ Contact : ${leadData.name} (${leadData.company})<br><br>
                ‚úÖ Demande bien enregistr√©e. Souhaitez-vous √™tre rappel√© par un expert <strong>${routing.name}</strong> ?
            `;
          addBotMessage(summaryHTML);
          showChoices([
            { label: "‚úÖ Oui, √™tre rappel√©", value: "OUI", next: "ASK_PREF" },
            {
              label: "‚ùå Non, envoyer par mail uniquement",
              value: "NON",
              next: "FINAL",
            },
          ]);
          break;

        case "ASK_PREF":
          addBotMessage(
            `Parfait. Comment l'expert <strong>${leadData.holding}</strong> doit-il vous contacter ?`,
          );
          showChoices([
            {
              label: "üìû Appel t√©l√©phonique",
              value: "Appel",
              field: "contactPref",
              next: "FINAL",
            },
            {
              label: "üí¨ WhatsApp",
              value: "WhatsApp",
              field: "contactPref",
              next: "FINAL",
            },
            {
              label: "‚úâÔ∏è Email",
              value: "Email",
              field: "contactPref",
              next: "FINAL",
            },
          ]);
          break;

        case "FINAL":
          const h = routeToHolding();
          addBotMessage(
            `Merci ! Notre <strong>${h.expert}</strong> vous contactera sous peu.`,
          );
          addBotMessage(
            "Signature : <em>SEATRUST GROUP | Multimodal Logistics Integrator</em>",
          );
          console.log("LEAD GENERATED:", leadData);
          break;
      }
    };

    // --- SAISIE TEXTE LIBRE ---
    window.submitText = function () {
      const input = document.getElementById("userInput");
      const val = input.value.trim();
      if (!val) return;

      addUserMessage(val);
      input.value = "";

      if (currentState === "ASK_ORIGIN") {
        leadData.origin = val;
        currentState = "ASK_DEST";
      } else if (currentState === "ASK_DEST") {
        leadData.destination = val;
        currentState = "ASK_COMMODITY";
      } else if (currentState === "ASK_COMMODITY") {
        leadData.commodity = val;
        currentState = "ASK_REEFER";
      } else if (currentState === "ASK_TEMP") {
        leadData.temp = val;
        currentState = "ASK_VOL";
      } else if (currentState === "ASK_URGENCY") {
        leadData.urgency = val;
        currentState = "ASK_NAME";
      } else if (currentState === "ASK_NAME") {
        const parts = val.split("/");
        leadData.name = parts[0];
        leadData.company = parts[1] || "Non pr√©cis√©e";
        currentState = "ASK_CONTACT";
      } else if (currentState === "ASK_CONTACT") {
        const parts = val.split("/");
        leadData.email = parts[0];
        leadData.phone = parts[1] || "Non pr√©cis√©";
        currentState = "SUMMARY";
      }

      setTimeout(nextStep, 600);
    };

    // --- LISTENERS ---
    document.getElementById("sendBtn").onclick = submitText;
    document.getElementById("userInput").onkeypress = (e) => {
      if (e.key === "Enter") submitText();
    };

    const chatBtn = document.getElementById("chat-button");
    const chatBox = document.getElementById("chat-box");
    const closeChat = document.getElementById("closeChat");

    chatBtn.onclick = () => chatBox.classList.toggle("hidden");
    closeChat.onclick = () => chatBox.classList.add("hidden");
  });
</script>

