---
import "../../../public/style/map.css";
import { ui } from "../../src/i18n/ui";

const { lang = "en" } = Astro.props;
const t = ui[lang];
---

<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<!-- CENTERED HEADER -->

<div class="container our-headline">
    <div class="row justify-content-center mb-5">
        <h2>
            {t["where_we_are.secion.name"]["p1"]}
            <br />
            {t["where_we_are.secion.name"]["p2"]}
        </h2>
    </div>
</div>

<section id="logistics-map-section">
    <!-- UI OVERLAY -->
    <div class="ui-overlay">
        <div class="ui-content">
            <!-- BUTTON 1: CENTERS -->
            <div id="btn-centers" class="toggle-btn active">
                <span>{t["where_we_are.secion.btns"][0].title}</span>
                <div class="status-dot"></div>
            </div>

            <!-- LIST -->
            <div id="centers-list"></div>

            <!-- BUTTON 2: NETWORK -->
            <div id="btn-network" class="toggle-btn">
                <span>{t["where_we_are.secion.btns"][1].title}</span>
                <div class="status-dot"></div>
            </div>

            <!-- BUTTON 3: TRACKING -->
            <div id="btn-track" class="toggle-btn">
                <span>{t["where_we_are.secion.btns"][2].title}</span>
                <div class="status-dot"></div>
            </div>

            <!-- FORM -->
            <div id="tracking-form-container">
                <label class="form-label"
                    >{t["where_we_are.secion.form"][0].labels[0].title}</label
                >
                <select id="start-select" class="form-select"></select>

                <label class="form-label"
                    >{t["where_we_are.secion.form"][0].labels[1].title}</label
                >
                <select id="end-select" class="form-select"></select>

                <!-- NEW FIELDS -->
                <label class="form-label"
                    >{t["where_we_are.secion.form"][0].labels[2].title}</label
                >
                <input
                    type="email"
                    id="user-email"
                    class="form-input"
                    placeholder="email@example.com"
                    required
                />

                <label class="form-label"
                    >{t["where_we_are.secion.form"][0].labels[3].title}</label
                >
                <input
                    type="tel"
                    id="user-phone"
                    class="form-input"
                    placeholder="+212 600 000 000"
                    required
                />

                <button id="calc-btn" class="action-btn"
                    >{t["where_we_are.secion.form"][1].button}</button
                >
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <button id="zoom-in" class="zoom-btn">+</button>
        <button id="zoom-out" class="zoom-btn">−</button>
    </div>

    <!-- THE ACTUAL MAP DIV -->
    <div id="map"></div>

    <!-- THE BOTTOM SHEET (Mobile Only) -->
    <div class="top-sheet" id="mobile-sheet">
        <div class="sheet-body">
            <div id="btn-centers-mobile" class="sheet-btn">
                <i class="bi bi-building"></i>
                {t["where_we_are.secion.btns"][0].title}
            </div>
            <div id="mobile-centers-list-container" class="nested-list"></div>

            <div id="btn-network-mobile" class="sheet-btn">
                <i class="bi bi-globe"></i>
                {t["where_we_are.secion.btns"][1].title}
            </div>

            <div id="btn-track-mobile" class="sheet-btn">
                <i class="bi bi-truck"></i>
                {t["where_we_are.secion.btns"][2].title}
            </div>

            <div
                id="mobile-tracking-container"
                style="display: none;"
                class="nested-form"
            >
                <label class="form-label">ORIGIN (MOROCCO)</label>
                <select id="start-select-mobile" class="form-select"></select>

                <label class="form-label">DESTINATION (WORLD)</label>
                <select id="end-select-mobile" class="form-select"></select>

                <label class="form-label">EMAIL ADDRESS</label>
                <input
                    type="email"
                    id="user-email-mobile"
                    class="form-input"
                    placeholder="email@example.com"
                />

                <label class="form-label">PHONE NUMBER</label>
                <input
                    type="tel"
                    id="user-phone-mobile"
                    class="form-input"
                    placeholder="+212 600 000 000"
                />

                <button id="calc-btn-mobile" class="action-btn"
                    >Calculate Route</button
                >
            </div>
        </div>

        <div class="sheet-handle-area" id="sheet-header">
            <span class="sheet-title">Logistics Dashboard</span>
            <div class="drag-handle"></div>
        </div>
    </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const BRAND_ORANGE = "#F08B33";
        const PATH_COLOR = "#003366"; // The Blue color for your paths
        const worldBounds = L.latLngBounds([-90, -180], [90, 180]);

        const sheet = document.getElementById("mobile-sheet");
        const sheetHeader = document.getElementById("sheet-header");

        // TOGGLE SHEET POSITION
        sheetHeader.addEventListener("click", () => {
            sheet.classList.toggle("expanded");
        });

        document
            .getElementById("btn-centers-mobile")
            .addEventListener("click", () => {
                // Trigger the same logic as the desktop button
                document.getElementById("btn-centers").click();
                // Optional: Close sheet halfway after clicking?
            });

        document
            .getElementById("btn-network-mobile")
            .addEventListener("click", () => {
                document.getElementById("btn-network").click();
                sheet.classList.remove("expanded"); // Auto-close to show the map lines
            });

        document
            .getElementById("btn-track-mobile")
            .addEventListener("click", () => {
                // Show the form inside the sheet
                const form = document.getElementById(
                    "mobile-tracking-container",
                );
                form.style.display =
                    form.style.display === "block" ? "none" : "block";
            });

        // 1. Initialize Map + Fix Duplication
        const map = L.map("map", {
            zoomControl: false,
            scrollWheelZoom: false,
            zoomSnap: 0.1,
            zoomDelta: 0.5,
            maxBounds: worldBounds,
            maxBoundsViscosity: 1.0,
            worldCopyJump: false,
        }).setView([31.0, -7.0], 5.5);

        setPerfectMinZoom();
        window.addEventListener("resize", setPerfectMinZoom);

        function setPerfectMinZoom() {
            const mapContainer = document.getElementById("map");
            const width = mapContainer.offsetWidth;

            // Formula to find zoom level that fits 360 degrees into 'width' pixels
            // zoom = log2(width / 256)
            const minZoom = Math.log2(width / 256);

            map.setMinZoom(minZoom);

            // If current zoom is too small, zoom in to the new minimum
            if (map.getZoom() < minZoom) {
                map.setZoom(minZoom);
            }
        }

        // 2. Tile Layer
        L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png",
            {
                noWrap: true,
                bounds: worldBounds,
                crossOrigin: true,
            },
        ).addTo(map);

        map.setView([33, -7], 5.5);

        // 3. Data
        const moroccoData = [
            {
                name: "Casablanca",
                coords: [33.5731, -7.5898],
                address: "12, Rue El Oraibi Jilali",
                phone: "+212 522 435 090",
            },
            {
                name: "Tanger",
                coords: [35.7595, -5.834],
                address: "11, Angle Av.Med,V",
                phone: "+212 539 329 490",
            },
            {
                name: "Rabat (Bouregreg)",
                coords: [34.0209, -6.8416],
                address: "Quai de la Marina, Bouregreg",
                phone: "",
            },
            {
                name: "Mohammedia",
                coords: [33.6866, -7.3811],
                address: "Bd. Hassan II",
                phone: "",
            },
            {
                name: "Jorf Lasfar",
                coords: [33.1198, -8.6363],
                address: "121, Route Sidi Bouzid",
                phone: "+212 523 372 338",
            },
            {
                name: "Safi",
                coords: [32.2994, -9.2372],
                address: "Zone Portuaire, Safi",
                phone: "",
            },
            {
                name: "Agadir",
                coords: [30.4278, -9.5981],
                address: "Enceinte Port Anza",
                phone: "+212 528 299 330",
            },
            {
                name: "Nador",
                coords: [35.1681, -2.9335],
                address: "Entrée Port Beni Ansar",
                phone: "+212 536 349 884",
            },
            {
                name: "Tan-Tan",
                coords: [28.438, -11.1032],
                address: "Port de Tan-Tan (El Ouatia)",
                phone: "",
            },
            {
                name: "Tarfaya",
                coords: [27.9392, -12.9261],
                address: "Avenue Mohammed V, Port Area",
                phone: "",
            },
            {
                name: "Laayoune",
                coords: [27.1253, -13.4125],
                address: "Port de Laayoune (Marsa)",
                phone: "",
            },
            {
                name: "Boujdour",
                coords: [26.1259, -14.482],
                address: "Quartier Administratif, Port Area",
                phone: "",
            },
            {
                name: "Dakhla",
                coords: [23.7, -15.95],
                address: "Route du Port, Dakhla South",
                phone: "",
            },
        ];

        const partnersData = [
            { name: "Rotterdam", coords: [51.9225, 4.47917] },
            { name: "New York", coords: [40.7128, -74.006] },
            { name: "Shanghai", coords: [31.2304, 121.4737] },
            { name: "Dubai", coords: [25.2048, 55.2708] },
            { name: "Santos", coords: [-23.9608, -46.3331] },
            { name: "Cape Town", coords: [-33.9249, 18.4241] },
        ];

        // 4. Layers
        const centersLayer = L.layerGroup().addTo(map);
        const networkLayer = L.layerGroup();
        const trackingLayer = L.layerGroup().addTo(map);
        const markersMap = new Map();

        function createLampIcon(size) {
            return L.divIcon({
                className: "lamp-marker",
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
            });
        }

        // 5. Build Initial Markers
        moroccoData.forEach((c) => {
            const m = L.marker(c.coords, {
                icon: createLampIcon(16),
            }).bindTooltip(`<strong>${c.name}</strong><br>${c.address}`, {
                direction: "top",
                className: "custom-tooltip",
                offset: [0, -10],
            });
            markersMap.set(c.name, m);
            centersLayer.addLayer(m);
        });

        // Sidebar
        const listContainer = document.getElementById("centers-list");

        moroccoData.forEach((center) => {
            const item = document.createElement("div");
            item.className = "center-item";
            item.innerHTML = `
            <span class="center-name">${center.name}</span>
            <small>Tél : ${center.phone}</small><br>
            <small>${center.address}</small>
        `;

            item.addEventListener("click", () => {
                // 1. Remove 'selected' class from all other items
                document.querySelectorAll(".center-item").forEach((el) => {
                    el.classList.remove("selected");
                });

                // 2. Add 'selected' class to the clicked item
                item.classList.add("selected");

                // 3. Map interactions (Existing logic)
                map.flyTo(center.coords, 11);
                markersMap.get(center.name).openTooltip();
            });

            listContainer.appendChild(item);
        });

        // Tracking Form Population
        const startSel = document.getElementById("start-select");
        const endSel = document.getElementById("end-select");
        moroccoData.forEach((c) => startSel.add(new Option(c.name, c.name)));
        partnersData.forEach((p) => endSel.add(new Option(p.name, p.name)));

        const state = { centers: true, network: false, tracking: false };

        // --- BUTTON HANDLERS ---

        // BUTTON 1: Main Offices
        document
            .getElementById("btn-centers")
            .addEventListener("click", function () {
                state.centers = !state.centers;
                this.classList.toggle("active");

                if (state.centers) {
                    map.addLayer(centersLayer);
                    listContainer.style.display = "block";
                    map.flyTo([31, -7], 5.5);
                } else {
                    map.removeLayer(centersLayer);
                    listContainer.style.display = "none";

                    // REMOVE SELECTION when closing the list
                    document
                        .querySelectorAll(".center-item")
                        .forEach((el) => el.classList.remove("selected"));
                }
            });

        // BUTTON 2: Global Network (UPDATED TO SHOW BLUE PATHS)
        document
            .getElementById("btn-network")
            .addEventListener("click", function () {
                state.network = !state.network;
                this.classList.toggle("active");

                if (state.network) {
                    networkLayer.clearLayers();

                    // 1. Draw Partner Markers
                    partnersData.forEach((p) => {
                        L.marker(p.coords, { icon: createLampIcon(8) })
                            .bindTooltip(p.name, {
                                permanent: true,
                                direction: "top",
                                className: "city-label-permanent",
                            })
                            .addTo(networkLayer);
                    });

                    // 2. Draw Connection Paths in Blue
                    // We'll connect major hubs (Tanger/Casablanca) to the partners
                    const hubTanger = moroccoData.find(
                        (x) => x.name === "Tanger",
                    ).coords;
                    const hubCasa = moroccoData.find(
                        (x) => x.name === "Casablanca",
                    ).coords;

                    partnersData.forEach((p, index) => {
                        // Alternating hub connections for a cleaner look
                        const startPoint =
                            index % 2 === 0 ? hubTanger : hubCasa;

                        L.polyline([startPoint, p.coords], {
                            color: PATH_COLOR,
                            weight: 1.5,
                            opacity: 0.5,
                            dashArray: "5, 10", // Dashed look for network connections
                            className: "animated-path", // Re-uses the movement animation
                        }).addTo(networkLayer);
                    });

                    map.addLayer(networkLayer);
                    map.flyTo([20, 0], 2.5);
                } else {
                    map.removeLayer(networkLayer);
                    map.flyTo([31, -7], 5.5);
                }
            });

        // BUTTON 3: Track Ship Path
        document
            .getElementById("btn-track")
            .addEventListener("click", function () {
                state.tracking = !state.tracking;
                this.classList.toggle("active");
                document.getElementById(
                    "tracking-form-container",
                ).style.display = state.tracking ? "block" : "none";
                if (!state.tracking) trackingLayer.clearLayers();
            });

        // Calculate Route
        document.getElementById("calc-btn").addEventListener("click", () => {
            // 1. Get references to the input fields
            const emailInput = document.getElementById("user-email");
            const phoneInput = document.getElementById("user-phone");

            // 2. Validation: Check if Email and Phone are provided
            if (!emailInput.value.trim() || !phoneInput.value.trim()) {
                alert(
                    "Please enter your Email and Phone Number to see the route.",
                );

                // Optional: Highlight the fields in red to show they are missing
                if (!emailInput.value.trim())
                    emailInput.style.borderColor = "#F08B33";
                if (!phoneInput.value.trim())
                    phoneInput.style.borderColor = "#F08B33";
                return;
            }

            // 3. Reset styles if they were previously highlighted
            emailInput.style.borderColor = "#444";
            phoneInput.style.borderColor = "#444";

            // 4. Clear existing layers (Original logic starts here)
            trackingLayer.clearLayers();

            // 5. Find Coordinates
            const s = moroccoData.find((x) => x.name == startSel.value).coords;
            const e = partnersData.find((x) => x.name == endSel.value).coords;

            // 6. Create Destination Marker
            const dest = L.marker(e, { icon: createLampIcon(16) }).bindTooltip(
                endSel.value,
                {
                    permanent: true,
                    direction: "top",
                    className: "city-label-permanent",
                },
            );

            // 7. Create Animated Polyline
            const line = L.polyline([s, e], {
                color: PATH_COLOR,
                weight: 3,
                className: "animated-path",
            });

            // 8. Add to Map and Zoom
            trackingLayer.addLayer(dest).addLayer(line);
            map.flyToBounds(L.latLngBounds(s, e), { padding: [100, 100] });

            // Optional: Log data for lead capture
            console.log(
                "Routing Request From:",
                emailInput.value,
                "| Phone:",
                phoneInput.value,
            );
        });

        // Zoom
        document
            .getElementById("zoom-in")
            .addEventListener("click", () => map.zoomIn());
        document
            .getElementById("zoom-out")
            .addEventListener("click", () => map.zoomOut());
    });
</script>
